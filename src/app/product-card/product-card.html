@if (!isLoading && product) {
<div class="container py-4 mt-5" dir="rtl">
  <div class="row g-4">
    <!-- ✅ صور المنتج -->
    <div class="col-12 col-md-5">
      <div class="p-3 bg-white text-center position-relative rounded-4">
        <!-- Favorite -->
        <button class="btn btn-outline-secondary rounded-circle position-absolute top-0 start-0 m-3"
          style="border-color:#00000033;z-index:2;" (click)="toggleFavorite(product, $event)">
          <i [ngClass]="product.isFavorite ? 'fa-solid fa-heart text-danger' : 'fa-regular fa-heart text-muted'"></i>
        </button>

        <!-- Main Image -->
        <div class="mb-2 p-4 border border-1 rounded-4">
          <img [src]="product.images[selectedImageIndex]" class="img-fluid" style="height:300px;object-fit:contain;" />
        </div>

        <!-- Thumbnails -->
        <div class="d-flex justify-content-center gap-2 mt-2">
          <img *ngFor="let image of product.images; let i=index" [src]="image" class="img-thumbnail"
            [class.border-primary]="i===selectedImageIndex"
            style="width:60px;height:60px;object-fit:contain;cursor:pointer;" (click)="selectedImageIndex=i" />
        </div>
      </div>
    </div>

    <!-- ✅ تفاصيل المنتج -->
    <div class="col-12 col-md-7">
      <div class="p-4 bg-white h-100 d-flex flex-column rounded-4">
        <p *ngIf="product.is_top_seller" class="d-inline-flex align-items-center p-2 rounded w-auto mb-3">
          <img src="assets/Images/star-circle.svg" alt="" class="me-2">
          {{ 'PRODUCT.TOP_SELLER' | translate }}
        </p>


        <h4 class="fw-bold fs-4">{{ product.name_ar }}</h4>

        <!-- Rating -->
        <div class="mb-3">
          <div class="mb-2 d-flex align-items-center">
            @for (star of [1,2,3,4,5]; track star) {
            <i class="fa-star" [class.fa-solid]="star <= (product.average_rating ?? 0)"
              [class.fa-regular]="star > (product.average_rating ?? 0)" style="color:#cacaca;"></i>
            }
            <small class="text-muted ms-2">({{ product.average_rating ?? 0 }})</small>
          </div>
          <small class="text-muted">({{ product.stock }} متوفر)</small>
        </div>

        <!-- Price -->
        <div class="mb-3">
          @if (product.sale_price) {
          <span class="text-success fw-bold fs-5">{{ product.sale_price }} ر.س</span>
          <span class="text-muted text-decoration-line-through ms-2">{{ product.price }} ر.س</span>
          } @else {
          <span class="fw-bold fs-5 text-dark">{{ product.price }} ر.س</span>
          }
        </div>

        <!-- Add to cart + Compare -->
        <div class="d-flex flex-wrap gap-2 mb-3">
          @if (isInCart(product.id)) {
          <div
            class="d-flex  mt-2 align-items-center justify-content-center py-1 px-3 gap-2 border border-secondary rounded-2"
            style="background-color:#7AD03A;direction:rtl; ">
            <button class="btn custom-increase-btn btn-sm"
              (click)="decreaseQuantity(product.id);$event.stopPropagation()">
              <i class="fa-solid fa-minus"></i>
            </button>
            <span class="fw-bold custom-qty-display text-center px-3">
              {{ getCartItem(product.id)?.quantity }}
            </span>
            <button class="btn custom-increase-btn btn-sm"
              (click)="increaseQuantity(product.id);$event.stopPropagation()">
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>
          } @else {
          <button class="btn mt-2 text-black rounded-2 custom-hover px-3 py-2" style="background-color:#7AD03A;"
            (click)="addToCart(product,$event)">
            <img src="assets/Images/shopping-cart-add-01.svg" style="width:20px;" class="px-1">
            {{ 'ADD_TO_CART' | translate }}
          </button>

          }

          <button (click)="addToCompare(product);$event.preventDefault();$event.stopPropagation()"
            class="px-3 py-2 mt-2 rounded-2 border border-secondary" [ngClass]="{'active':isInCompare(product)}">
            <img src="assets/Images/arrow-data-transfer-horizontal.svg" alt="" class="px-2"> قارن
          </button>
        </div>

        <!-- Tabs -->
        <div class="d-flex gap-2 mb-3">
          <button class="tab-btn" [class.active]="showDescription"
            (click)="showDescription=true;showReviews=false">الوصف</button>
          <button class="tab-btn" [class.active]="showReviews"
            (click)="showDescription=false;showReviews=true">التقييمات</button>
        </div>

        <!-- Tab Content -->
        <div *ngIf="showDescription" class="border-top pt-3">
          <h6 class="fw-bold">الوصف</h6>
          <p class="text-muted" style="white-space:pre-line;">
            {{ showFullDescription ? (product.description_ar || product.description) : shortDescription }}
          </p>
          @if (hasMore) {
          <button class="btn btn-link p-0" (click)="showFullDescription=!showFullDescription">
            {{ showFullDescription ? 'عرض أقل' : 'عرض المزيد' }}
          </button>
          }
        </div>

        <div *ngIf="showReviews" class="border-top pt-3">
          <h6 class="fw-bold">التقييمات والمراجعات</h6>
          <div *ngIf="product.reviews?.length; else noReviews">
            <div *ngFor="let review of product.reviews" class="mb-3 p-2 bg-light rounded">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>{{ review.client_name }}</strong>
                <small class="text-muted">{{ review.created_at | date:'short' }}</small>
              </div>
              <div class="mb-1">
                <ng-container *ngFor="let star of [1,2,3,4,5]">
                  <i class="fa-star" [class.fa-solid]="star <= review.rating" [class.fa-regular]="star > review.rating"
                    style="color:gold;"></i>
                </ng-container>
              </div>
              <p class="mb-0">{{ review.comment }}</p>
            </div>
          </div>
          <ng-template #noReviews>
            <p class="text-muted">لا توجد مراجعات لهذا المنتج بعد.</p>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- ✅ منتجات ذات صلة -->
<div style="background-color:#081E25;" class="py-5 px-lg-5 mx-0">
  <div class="d-flex text-light justify-content-between align-items-center flex-wrap mb-3 px-4">
    <h2 class="section-title mb-0 fw-bold">{{ 'RELATED_PRODUCTS' | translate }}</h2>
  </div>

  <div class="row g-3 d-md-none px-3">
    <!-- 📱 موبايل: صفوف 2 كروت -->
    @for (product of filteredProducts; track product.id) {
    <div class="col-6">
      <div class="card product-card rounded-4 h-100 position-relative">
        <!-- أزرار المفضلة والمقارنة -->
        <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-2">
          <button (click)="toggleFavorite(product); $event.stopPropagation()" class="btn-circle"
            [ngClass]="product.isFavorite ? 'text-danger' : 'text-muted'">
            <i class="fa-heart" [ngClass]="product.isFavorite ? 'fa-solid' : 'fa-regular'"></i>
          </button>

          <button (click)="addToCompare(product); $event.preventDefault(); $event.stopPropagation()" class="btn-circle"
            [ngClass]="{'active': isInCompare(product)}">
            <img src="assets/Images/arrow-data-transfer-horizontal.svg" alt="">
          </button>
        </div>

        <a [routerLink]="['/product', product.id]" class="text-decoration-none text-dark">
          <img [src]="product.images[0]" class="card-img-top p-3" [alt]="product.name"
            style="height:140px;object-fit:contain;" />
          <div class="card-body">
            <h6 class="fw-bold mb-2">{{ (currentLang==='ar'?product.name_ar:product.name)|truncate:25 }}</h6>
            <p class="text-muted small mb-2">{{
              (currentLang==='ar'?product.description_ar:product.description)|truncate:40 }}</p>
            <span class="fw-bold text-success">{{ product.price }} {{ 'CURRENCY'|translate }}</span>
          </div>
        </a>
      </div>
    </div>
    }
  </div>

  <!-- 💻 ديسكتوب: كروسل -->
  <div class="position-relative carousel-wrapper my-3 d-none d-md-block">
    <div class="carousel-container">
      <div class="d-flex transition-transform carousel-track" [ngStyle]="{
        transform: currentLang === 'ar'
          ? 'translateX(+' + (currentSlideIndex * (100 / visibleCards)) + '%)'
          : 'translateX(-' + (currentSlideIndex * (100 / visibleCards)) + '%)'
      }" [dir]="currentLang === 'ar' ? 'rtl' : 'ltr'">
        @for (product of filteredProducts; track product.id) {
        <div class="carousel-slide p-3">
          <div class="card product-card rounded-4 h-100 position-relative">
            <!-- أزرار المفضلة والمقارنة -->
            <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-2">
              <button (click)="toggleFavorite(product); $event.stopPropagation()" class="btn-circle"
                [ngClass]="product.isFavorite ? 'text-danger' : 'text-muted'">
                <i class="fa-heart" [ngClass]="product.isFavorite ? 'fa-solid' : 'fa-regular'"></i>
              </button>

              <button (click)="addToCompare(product); $event.preventDefault(); $event.stopPropagation()"
                class="btn-circle" [ngClass]="{'active': isInCompare(product)}">
                <img src="assets/Images/arrow-data-transfer-horizontal.svg" alt="">
              </button>
            </div>

            <a [routerLink]="['/product', product.id]" class="text-decoration-none text-dark">
              <img [src]="product.images[0]" class="card-img-top p-3" [alt]="product.name"
                style="height:180px;object-fit:contain;" />
              <div class="card-body">
                <h6 class="fw-bold mb-2">{{ (currentLang==='ar'?product.name_ar:product.name)|truncate:25 }}</h6>
                <p class="text-muted small mb-2">{{
                  (currentLang==='ar'?product.description_ar:product.description)|truncate:40 }}</p>
                <span class="fw-bold text-success">{{ product.price }} {{ 'CURRENCY'|translate }}</span>
              </div>
            </a>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Navigation -->
    <div class="d-flex align-items-center justify-content-between mt-4 px-lg-4">
      <div class="d-flex gap-2 justify-content-center mx-auto">
        @for (i of getDotsArray(); track i) {
        <button (click)="goToSlide(i)" class="rounded-circle" [class.bg-success]="currentSlideIndex===i"
          [class.bg-secondary]="currentSlideIndex!==i" style="width:10px;height:10px;border:none;"></button>
        }
      </div>
      <div class="d-flex gap-2">
        <button class="arrow-btn next" (click)="nextSlide()"
          [disabled]="currentSlideIndex >= getTotalSlides() - 1"></button>
        <button class="arrow-btn prev" (click)="prevSlide()" [disabled]="currentSlideIndex === 0"></button>
      </div>
    </div>
  </div>
</div>

<app-downloadapp></app-downloadapp>