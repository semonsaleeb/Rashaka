<!-- product-page.component.html -->
@if (!isLoading && product) {
<div class="container py-4 mt-5" dir="rtl">
  <div class="row g-4">
 <!-- Product Image + Thumbnails -->
<div class="col-md-5 rounded" style="">
  <div class="p-3 bg-white text-center position-relative">

    <!-- Favorite button -->
    <button class="btn btn-outline-secondary rounded-circle position-absolute top-0 start-0 m-5"
      style="border-color: #00000033; z-index: 2;" (click)="toggleFavorite(product, $event)">
      <i [ngClass]="product.isFavorite ? 'fa-solid fa-heart text-danger' : 'fa-regular fa-heart text-muted'"></i>
    </button>

    <!-- Main Image -->
    <div class="mb-2 p-5 border border-1 rounded-4">
      <img 
        [src]="product.images[selectedImageIndex]" 
        class="img-fluid" 
        style="height: 300px; object-fit: contain;"
      />
    </div>

    <!-- Thumbnails -->
    <div class="d-flex justify-content-center gap-2 mt-2">
      <img 
        *ngFor="let image of product.images; let i = index"
        [src]="image" 
        class="img-thumbnail"
        [class.border-primary]="i === selectedImageIndex"
        style="width: 60px; height: 60px; object-fit: contain; cursor: pointer;"
        (click)="selectedImageIndex = i"
      />
    </div>

  </div>
</div>


    <!-- Product Info -->
    <div class="col-md-7">
      <div class="p-4 bg-white h-100 d-flex flex-column">
        <p *ngIf="product.is_top_seller" class=" d-inline-flex align-items-center p-2 rounded w-25"
          style="border: 1px solid #00000033;">
          <img src="assets/Images/star-circle.svg" alt="" class="me-2 mx-2"> الأكثر مبيعاً
        </p>


        <h4 class="fw-bold fs-5">{{ product.name_ar }}</h4>
        <!-- Name + Stock -->
        <div class="mb-3">
          <div class="mb-2 d-flex align-items-center">
            @for (star of [1,2,3,4,5]; track star) {
            <i class="fa-star" [class.fa-solid]="star <= (product.average_rating ?? 0)"
              [class.fa-regular]="star > (product.average_rating ?? 0)" style="color: gold;">
            </i>
            }
            <small class="text-muted ms-2">
              ({{ product.average_rating ?? 0 }})
            </small>
          </div>







          <small class="text-muted">({{ product.stock }} متوفر)</small>
        </div>
        <!-- Price + Category -->
        <div class="d-flex align-items-center gap-2 mb-2">
          @if (product.sale_price) {
          <span class="text-success fw-bold fs-5">
            {{ product.sale_price }} ر.س
          </span>
          <span class="text-muted text-decoration-line-through">
            {{ product.price }} ر.س
          </span>
          } @else {

          <span class="fw-bold fs-5 text-dark">{{ product.price }} ر.س</span>
          }

          <!-- @if (product.categories && product.categories.length) {
          <span class="badge bg-secondary">
            {{ product.categories[0].name_ar }}
          </span>
          } -->
        </div>



        <!-- Add to cart -->
        <div class="d-flex gap-2 mb-3">
        @if (isInCart(product.id)) {
  <!-- ✅ حالة المنتج موجود في الكارت -->
  <div
    class="d-flex align-items-center justify-content-center px-3 mt-2 gap-2 border border-secondary rounded-2"
    style="direction: rtl; font-size: 0.9rem; background-color: #7AD03A;"
  >
    <!-- Quantity Controls -->
    <div class="d-flex align-items-center gap-2 Quantity_Controls">
      <!-- Increase Button -->
      <button class="btn custom-increase-btn btn-sm"
                        (click)="decreaseQuantity(product.id); $event.stopPropagation()">
                        <i class="fa-solid fa-minus"></i>

                        <!-- <img src="assets/Images/delete-02.svg"> -->
                      </button>

      <!-- Quantity Display -->
      <span class="fw-bold custom-qty-display text-center px-4">
        {{ getCartItem(product.id)?.quantity }}
      </span>

      <!-- Decrease Button -->
       <button class="btn custom-increase-btn btn-sm "
                        (click)="increaseQuantity(product.id); $event.stopPropagation()">
                        <i class="fa-solid fa-plus"></i>
                      </button>
    </div>
  </div>
} @else {
  <!-- ❌ حالة المنتج مش موجود في الكارت -->
  <button class="btn  btn-xs  mt-3 text-black rounded-2 custom-hover px-3 py-2"
    style="font-size: 0.9rem; background-color: #7AD03A;"
    (click)="addToCart(product, $event)"
    data-bs-toggle="offcanvas" data-bs-target="#cartSidebar" aria-controls="cartSidebar">

    <img src="assets/Images/shopping-cart-add-01.svg" style="width: 24px;" class="px-1">
    {{ 'ADD_TO_CART' | translate }}
  </button>
}


        </div>

        <div class="d-flex gap-2 mb-3">
          <div class="d-flex gap-2 mb-3">
            <button class="tab-btn" [class.active]="showDescription"
              (click)="showDescription = true; showReviews = false">
              الوصف
            </button>
            <button class="tab-btn" [class.active]="showReviews" (click)="showDescription = false; showReviews = true">
              التقييمات
            </button>
          </div>

        </div>

        <div *ngIf="showDescription" class="border-top pt-3">
          <h6 class="fw-bold">الوصف</h6>
          <p class="text-muted" style="white-space: pre-line;">
            {{ showFullDescription ? (product.description_ar || product.description) : shortDescription }}
          </p>

          @if (hasMore) {
          <button class="btn btn-link p-0" (click)="showFullDescription = !showFullDescription">
            {{ showFullDescription ? 'عرض أقل' : 'عرض المزيد' }}
          </button>
          }

        </div>

        <div *ngIf="showReviews" class="border-top pt-3">
          <h6 class="fw-bold">التقييمات والمراجعات</h6>

          <div *ngIf="product.reviews?.length; else noReviews">
            <div *ngFor="let review of product.reviews" class="mb-3 p-2 bg-light rounded">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong>{{ review.client_name }}</strong>
                <small class="text-muted">{{ review.created_at | date:'short' }}</small>
              </div>

              <div class="mb-1">
                <ng-container *ngFor="let star of [1,2,3,4,5]">
                  <i class="fa-star" [class.fa-solid]="star <= review.rating" [class.fa-regular]="star > review.rating"
                    style="color: gold;">
                  </i>
                </ng-container>
              </div>

              <p class="mb-0">{{ review.comment }}</p>
            </div>
          </div>

          <ng-template #noReviews>
            <p class="text-muted">لا توجد مراجعات لهذا المنتج بعد.</p>
          </ng-template>
        </div>

      </div>
    </div>
  </div>
</div>
<app-downloadapp></app-downloadapp>
}