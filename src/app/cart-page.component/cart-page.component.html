<div class="container my-4" dir="rtl">

  <!-- إذا كانت العربة فارغة -->
  @if (cartItems.length === 0) {
  <div class="text-center">
    <div class="align-items-center mt-5 py-5 ">
      <img src="assets/Images/Add to Cart-cuate 1.svg" alt="" class="img-fluid" style="max-width: 200px;">
    </div>
    <h4 class="mt-3">عربة التسوق فارغة!</h4>
    <p class="text-muted small">
      أضف المنتجات اللي ترغب في شرائها وارجع لإتمام الطلب وقت ما تحب.
    </p>

    <button class="btn custom-green-btn mt-3 px-4 py-2" [routerLink]="['/home/category-products']">
      ابدا التسوق
    </button>
  </div>
  } @else {

  <!-- محتوى العربة -->
  <div class=" text-center p-2 mb-4 py-5">
    <h5 class="text-center d-flex justify-content-center align-items-center gap-2">
      <img src="assets/Images/Frame 9033.svg" class="img-fluid" style="max-height: 28px;">
      <span>عربة التسوق</span>
      <span class="badge bg-success rounded-pill">{{ totalCartItemsCount }}</span>
    </h5>
  </div>

  <div class="row g-4">
    <!-- Right Side: Cart Items -->
    <div class="col-12 col-lg-7">
      <h6 class="mb-4 text-end">
        <img src="assets/Images/delivery.svg" class="me-2" style="max-height: 22px;">
        <span> شحن مجاني للطلبات أكثر من </span>
        <strong>1000 ريال</strong>
      </h6>

      <div class="progress border border-c mb-3" style="height: 10px;">
        <div class="progress-bar" role="progressbar" [style.width.%]="progressValue"
          [attr.aria-valuenow]="progressValue" aria-valuemin="0" aria-valuemax="100" style="background-color: #2EA2CC;">
        </div>
      </div>

      @for (item of cartItems; track trackByFn($index, item)) {
      <div class="card mb-3 shadow-sm border-1 rounded-4 p-2" style="background-color: #FAFAFA;">
        <div class="row g-2 align-items-center">

          <!-- صورة المنتج -->
          <div class="col-3 text-center">
            @if (item.images && item.images.length > 0) {
            <img [src]="item.images[0]" class="img-fluid rounded-3" style="max-height: 70px;">
            } @else {
            <img src="assets/Images/placeholder.png" class="img-fluid rounded-3" style="max-height: 70px;">
            }
          </div>

          <!-- تفاصيل المنتج -->
          <div class="col-9">
            <div class="card-body text-end p-2">
              <h6 class="card-title fw-bold">{{ item.product_name_ar }}</h6>

              <!-- السعر -->
              <div class="small">
                @if ((+item.sale_unit_price! > 0) && (+item.sale_unit_price! !== +item.unit_price!)) {
                <span class="fw-bold text-success ms-2">{{ item.sale_unit_price }} ر.س</span>
                <span class="text-muted text-decoration-line-through">{{ item.unit_price }} ر.س</span>
                } @else {
                <span class="fw-bold text-dark">{{ item.unit_price }} ر.س</span>
                }
              </div>


              <!-- أزرار التحكم -->
              <div class="d-flex align-items-center justify-content-between mt-2">
                <button class="btn btn-outline-danger btn-sm" (click)="removeItem(item.product_id)">
                  <i class="fa-solid fa-trash"></i>
                </button>
                <div class="d-flex align-items-center gap-2 ">
                  <button class="btn btn-outline-secondary btn-sm" (click)="decreaseQuantity(item.product_id)">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                  <span>{{ item.quantity }}</span>
                  <button class="btn btn-outline-secondary btn-sm" (click)="increaseQuantity(item.product_id)">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      }
    </div>

    <!-- Left Side: Order Summary -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm border-1 rounded-4 p-4" style="background-color: #FAFAFA;">
        <h6 class="text-end mb-3">ملخص الطلب</h6>

        <!-- Promo Code -->
        <div class="input-group mb-3">
          <input type="text" class="form-control text-end rounded-0" placeholder="ادخل الكود" [(ngModel)]="promoCode">
          <button class="btn custom-green-btn rounded-0">تطبيق</button>
        </div>

        <!-- الأسعار -->
        <ul class="mb-3 text-end p-0 small">
          <li class="d-flex justify-content-between py-2">
            <span>المجموع</span>
            <span>
              @if (totalSalePrice) {
              <span class="text-muted text-decoration-line-through me-2">
                {{ totalPrice | number: '1.2-2' }} ر.س
              </span>
              <span class="fw-bold text-success">
                {{ totalSalePrice | number: '1.2-2' }} ر.س
              </span>
              } @else {
              <span class="fw-bold">
                {{ totalPrice | number: '1.2-2' }} ر.س
              </span>
              }
            </span>
          </li>

          <li class="d-flex justify-content-between py-2">
            <span>رسوم شحن</span>
            <span>30.00 ر.س</span>
          </li>

          <li class="d-flex justify-content-between fw-bold pt-3 border-top my-3">
            <span>الإجمالي</span>
            <span>{{ (totalSalePrice || totalPrice) + 30 | number: '1.2-2' }} ر.س</span>
          </li>
        </ul>

        @if (!token) {
        <button class="btn custom-green-btn w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#authModal">
          إتمام الطلب
        </button>
        } @else {
        <button class="btn custom-green-btn w-100 fw-bold" (click)="placeOrder()">
          إتمام الطلب
        </button>
        }

        <!-- Popup Modal -->
        <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-3">
              <!-- Close button -->
              <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
              </div>

              <!-- صورة -->
              <div class="text-center mb-3">
                <img src="assets/Images/Enter OTP-cuate 1.svg" alt="Login Illustration" style="max-width: 200px;">
              </div>

              <!-- العنوان -->
              <h5 class="text-center fw-bold mb-2">يرجى تسجيل الدخول أو إنشاء حساب جديد للمتابعة.</h5>

              <!-- الأزرار -->
              <div class="d-flex justify-content-center gap-3 mt-3">
                <button class="btn btn-outline-secondary px-4" (click)="goToRegister()" data-bs-dismiss="modal">
                  إنشاء الحساب
                </button>
                <button class="btn btn-success px-4" (click)="goToLogin()" data-bs-dismiss="modal">
                  تسجيل الدخول
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>