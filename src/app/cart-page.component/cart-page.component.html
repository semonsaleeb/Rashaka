<div class="container my-4" dir="rtl">

  <!-- إذا كانت العربة فارغة -->
  @if (cartItems.length === 0) {
  <div class="text-center">
    <div class="align-items-center mt-5 py-5 ">
      <img src="assets/Images/Add to Cart-cuate 1.svg" alt="" class="img-fluid" style="max-width: 200px;">
    </div>
    <h4 class="mt-3">{{ 'CART.EMPTY_TITLE' | translate }}</h4>
    <p class="text-muted small">
      {{ 'CART.EMPTY_DESC' | translate }}
    </p>

    <button class="btn custom-green-btn mt-3 px-4 py-2" [routerLink]="['/home/category-products']">
      {{ 'CART.START_SHOPPING' | translate }}
    </button>
  </div>
  } @else {

  <!-- محتوى العربة -->
  <div class=" text-center p-2 mb-4 py-5">
    <h5 class="text-center d-flex justify-content-center align-items-center gap-2">
      <img src="assets/Images/Frame 9033.svg" class="img-fluid" style="max-height: 28px;">
      <span>{{ 'CART.TITLE' | translate }}</span>
      <span class="badge bg-success rounded-pill">{{ totalCartItemsCount }}</span>
    </h5>
  </div>

  <div class="row g-4">
    <!-- Right Side: Cart Items -->
    <div class="col-12 col-lg-7">
      <h6 class="mb-4 text-end">
        <img src="assets/Images/delivery.svg" class="me-2" style="max-height: 22px;">
        <span>{{ 'CART.FREE_SHIPPING' | translate }}</span>
        <strong>{{ 'CART.AMOUNT' | translate }}</strong>
      </h6>

      <div class="progress border border-c mb-3" style="height: 10px;">
        <div class="progress-bar" role="progressbar" [style.width.%]="progressValue"
          [attr.aria-valuenow]="progressValue" aria-valuemin="0" aria-valuemax="100" style="background-color: #2EA2CC;">
        </div>
      </div>

      @for (item of cartItems; track trackByFn($index, item)) {
      <div class="card mb-3 shadow-sm border-1 rounded-4 p-2" style="background-color: #FAFAFA;">
        <div class="row g-2 align-items-center">

          <!-- صورة المنتج -->
          <div class="col-3 text-center">
            @if (item.images && item.images.length > 0) {
            <img [src]="item.images[0]" class="img-fluid rounded-3" style="max-height: 70px;">
            } @else {
            <img src="assets/Images/placeholder.png" class="img-fluid rounded-3" style="max-height: 70px;">
            }
          </div>

          <!-- تفاصيل المنتج -->
          <div class="col-9">
            <div class="card-body text-end p-2">
              <h6 class="card-title fw-bold">{{ item.product_name_ar }}</h6>

              <!-- السعر -->
              <div class="small">
                <!-- @if ((+item.unit_price_after_offers! > 0) && (+item.unit_price_after_offers! !== +item.price!)) {
    <span class="fw-bold text-success ms-2">
      {{ item.totalPrice }} {{ 'CART.CURRENCY' | translate }}
    </span>
    <span class="text-muted text-decoration-line-through">
      {{ item.total_price_after_offers }} {{ 'CART.CURRENCY' | translate }}
    </span>
  } @else {
    <span class="fw-bold text-dark">
      {{ item.totalPriceAfterOffers }} {{ 'CART.CURRENCY' | translate }}
    </span>
  } -->
                <span class="fw-bold text-success ms-2">
                  {{item.total_price_after_offers}} {{ 'CART.CURRENCY' | translate }}
                </span>
                <span class="text-muted text-decoration-line-through"
                  *ngIf="item.totalPrice !== item.totalPriceAfterOffers">
                  {{ item.totalPrice }} {{ 'CART.CURRENCY' | translate }}
                </span>

              </div>

              <!-- أزرار التحكم -->
              <div class="d-flex align-items-center justify-content-between mt-2">
                <button class="btn btn-outline-danger btn-sm" (click)="removeItem(item.product_id)">
                  <i class="fa-solid fa-trash"></i>
                </button>
                <div class="d-flex align-items-center gap-2 ">
                  <button class="btn btn-outline-secondary btn-sm" (click)="decreaseQuantity(item.product_id)">
                    <i class="fa-solid fa-minus"></i>
                  </button>
                  <span>{{ item.quantity }}</span>
                  <button class="btn btn-outline-secondary btn-sm" (click)="increaseQuantity(item.product_id)">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
      }
    </div>

    <!-- Left Side: Order Summary -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm border-1 rounded-4 p-4" style="background-color: #FAFAFA;">
        <h6 class="text-end mb-3">{{ 'CART.SUMMARY' | translate }}</h6>

        <!-- Promo Code -->
        <div class="input-group mb-3">
          <input type="text" class="form-control text-end rounded-0" [placeholder]="'CART.ENTER_CODE' | translate"
            [(ngModel)]="promoCode">
          <button class="btn custom-green-btn rounded-0" (click)="applyPromoCode()">
            {{ 'CART.APPLY' | translate }}
          </button>
        </div>

        <!-- الأسعار -->
        <ul class="mb-3 text-end p-0 small">
          <li class="d-flex justify-content-between py-2">
            <span>{{ 'CART.TOTAL' | translate }}</span>
            <span>
              @if (hasDiscount()) {
              <span class="text-muted text-decoration-line-through me-2">
                {{ totalPrice | number: '1.2-2' }} {{ 'CART.CURRENCY' | translate }}
              </span>
              <span class="fw-bold text-success">
                {{ totalSalePrice | number: '1.2-2' }} {{ 'CART.CURRENCY' | translate }}
              </span>
              } @else {
              <span class="fw-bold">
                {{ totalPrice | number: '1.2-2' }} {{ 'CART.CURRENCY' | translate }}
              </span>
              }
            </span>
          </li>
  <li class="d-flex justify-content-between py-2">
            <span>{{ 'CART.SHIPPING_FEE' | translate }}</span>
            <span>{{ shippingFee | number : '1.2-2' }} {{ 'CART.CURRENCY' | translate }}</span>
          </li>
          <li class="d-flex justify-content-between fw-bold pt-3 border-top my-3">
            <span>{{ 'CART.GRAND_TOTAL' | translate }}</span>
            <span>
              {{ (totalSalePrice || totalPrice) + 30 | number: '1.2-2' }}
              {{ 'CART.CURRENCY' | translate }}
            </span>
          </li>
        </ul>


        @if (!token) {
        <button class="btn custom-green-btn w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#authModal">
          {{ 'CART.CHECKOUT' | translate }}
        </button>
        } @else {
        <button class="btn custom-green-btn w-100 fw-bold" (click)="placeOrder()">
          {{ 'CART.CHECKOUT' | translate }}
        </button>
        }

        <!-- Popup Modal -->
        <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 p-3">
              <!-- Close button -->
              <div class="d-flex justify-content-end">
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                  [attr.aria-label]="'CART.CLOSE' | translate"></button>
              </div>

              <!-- صورة -->
              <div class="text-center mb-3">
                <img src="assets/Images/Enter OTP-cuate 1.svg" alt="Login Illustration" style="max-width: 200px;">
              </div>

              <!-- العنوان -->
              <h5 class="text-center fw-bold mb-2">{{ 'CART.LOGIN_REQUIRED' | translate }}</h5>

              <!-- الأزرار -->
              <div class="d-flex justify-content-center gap-3 mt-3">
                <button class="btn btn-outline-secondary px-4" (click)="goToRegister()" data-bs-dismiss="modal">
                  {{ 'CART.REGISTER' | translate }}
                </button>
                <button class="btn btn-success px-4" (click)="goToLogin()" data-bs-dismiss="modal">
                  {{ 'CART.LOGIN' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>