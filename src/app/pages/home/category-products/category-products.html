@if (showComparePopup) {
<app-compare-popup [products]="compareProducts" (close)="onCloseComparePopup()">
</app-compare-popup>
}


<!-- Carousel Mode -->
@if (mode === 'carousel') {
<div class="position-relative ">

  <!-- Left Pattern -->
  <img src="assets/Images/pattern.svg" class="left-pattern"
    style="position: absolute; left: 0; top: 20px; height: 200px; width: 100px; z-index: 1;">

  <!-- الخلفية تاخد العرض كله -->
  <div class="category-products-container py-5 px-lg-5">

    <!-- المحتوى الداخلي مع padding -->
    <div class="px-lg-5 px-3">
      @if (!isLoading) {
      <div class="special-offers-container mb-5">

        <!-- Header Section -->
        <div class="header-section mb-4 px-3" dir="rtl">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
            <h2 class="section-title mb-0 fw-bold">منتجاتنا المميزة</h2>
            <a [routerLink]="['/home/category-products']"
              class="btn btn-link view-all-btn text-light d-flex align-items-center gap-2 p-0">
              <img src="assets/Images/circle-arrow-up-right-02 (1).svg" alt="عرض الكل">
              عرض الكل
            </a>
          </div>

          <!-- Category Buttons -->
          <div class="category-buttons d-flex gap-2 py-3" [ngClass]="{'mobile-scroll': isMobile}">
            <button (click)="filterByCategory('all')" class="fw-bold" [ngClass]="{
              'btn': true,
              'btn-sm': true,
              'btn-success': selectedCategory === 'all',
              'btn-outline-success': selectedCategory !== 'all'
            }">
              الكل
            </button>

            @for (category of categories; track category.id) {
            <button (click)="filterByCategory(category.id)" class="fw-bold" [ngClass]="{
              'btn': true,
              'btn-sm': true,
              'btn-success': selectedCategory === category.id,
              'btn-outline-success': selectedCategory !== category.id
            }">
              {{ category.name_ar }}
            </button>
            }
          </div>

        </div>

        <!-- Carousel Container -->
        <div class="position-relative carousel-wrapper my-3" dir="rtl">
          <div class="carousel-container">
            <div class="d-flex transition-transform carousel-track" [ngStyle]="{
  transform: 'translateX(' + (currentSlideIndex * (isMobile ? (100 / visibleCards) : (100 / visibleCards))) + '%)'
}" (touchstart)="onTouchStart($event)" (touchend)="onTouchEnd($event)">
              @for (product of filteredProducts; track product.id) {
              <div class="carousel-slide p-3">
                <div class="card product-card rounded-4">
                  <a [routerLink]="['/product', product.id]" class="text-decoration-none text-dark">

                    <!-- Product Image -->
                    <div class="carousel slide">
                      <div class="carousel-inner">
                        @for (image of product.images; track $index; let j = $index) {
                        <div class="carousel-item" [class.active]="j === 0">
                          <img [src]="image" class="card-img-top p-3" [alt]="product.name">
                        </div>
                        }

                      </div>
                    </div>

                    <!-- Favorite & Compare Buttons -->
                    <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-2">
                      <button (click)="toggleFavorite(product, $event)" class="btn-circle"
                        [ngClass]="product.isFavorite ? 'text-danger' : 'text-muted'">
                        <i class="fa-heart" [ngClass]="product.isFavorite ? 'fa-solid' : 'fa-regular'"></i>
                      </button>

                      <button (click)="addToCompare(product); $event.preventDefault(); $event.stopPropagation()"
                        class="btn-circle text-muted">
                        <i class="fas fa-random"></i>
                      </button>
                    </div>

                    <!-- Product Details -->
                    <div class="card-body text-end mx-3">
                      <h6 class="card-title fw-bold text-black">{{ product.name_ar }}</h6>
                      <p class="card-text">{{ product.description }}</p>
                      <div>
                        <p class="fw-bold " style="font-size: 14px;">
                          @if (product.sale_price && product.sale_price !== product.price) {
                          <span class="fw-bold text-success">{{ product.sale_price }} ر.س </span>
                          <span class="text-secondary" style="text-decoration: line-through;">{{ product.price }}
                            ر.س</span>
                          } @else {
                          <span class="fw-bold text-success">{{ product.price }} ر.س </span>
                          }
                        </p>


                      </div>

                    </div>
                  </a>
                  <!-- Cart Controls -->
                  <div class="mb-2 px-4">
                    @if (isInCart(product.id)) {
                    <div class="d-flex align-items-center mb-1 justify-content-center px-3 mt-2 gap-2 border rounded-4"
                      style="direction: rtl;">

                      <!-- Quantity Controls -->
                      <div class="d-flex align-items-center gap-2">
                        <!-- Increase Button -->
                        <button class="btn custom-increase-btn btn-sm"
                          (click)="increaseQuantity(product.id); $event.stopPropagation()">
                          <i class="fa-solid fa-plus"></i>
                        </button>
                        <!-- Quantity Display -->
                        <span class="fw-bold custom-qty-display text-center">
                          {{ getCartItem(product.id)?.quantity }}
                        </span>
                        <!-- Remove Button -->
                        <button class="btn custom-remove-btn btn-sm"
                          (click)="removeItem(product.id); $event.stopPropagation()">
                          <img src="assets/Images/delete-02.svg">
                        </button>
                      </div>
                    </div>
                    } @else {
                    <button class="btn btn-outline-dark w-100 btn-xs bg-white mb-2 text-black rounded-5 custom-hover"
                      style="font-size: 1rem;" (click)="addToCart(product, $event)" data-bs-toggle="offcanvas"
                      data-bs-target="#cartSidebar" aria-controls="cartSidebar">
                      <img src="assets/Images/shopping-cart-add-01.svg" style="width: 24px;" class="px-1">

                      إضافة الي العربة
                    </button>





                    }
                  </div>

                </div>
              </div>
              }
            </div>
          </div>

          <!-- Navigation -->
          <div class="d-flex align-items-center justify-content-between mt-4 px-lg-4">

            <!-- Dots -->
            <div class="d-flex gap-2 justify-content-center mx-auto mx-md-0">
              @for (i of getDotsArray(); track i) {
              <button (click)="goToSlide(i)" class="rounded-circle" [class.bg-success]="currentSlideIndex === i"
                [class.bg-secondary]="currentSlideIndex !== i" style="width: 10px; height: 10px; border: none;">
              </button>
              }
            </div>

            <!-- Arrows (desktop only) -->
            <div class="d-flex gap-2 d-none d-md-flex">
              <button class="arrow-btn next" (click)="nextSlide()" [disabled]="currentSlideIndex >= getTotalSlides() - 1"></button>
              <button class="arrow-btn prev" (click)="prevSlide()" [disabled]="currentSlideIndex === 0"></button>

            </div>

          </div>


        </div>
      </div>
      } @else {
      <!-- Loading -->
      <div class="loading-spinner">
        <div class="spinner-border text-success" role="status"></div>
        <p>جاري تحميل المنتجات...</p>
      </div>
      }
    </div>
  </div>

  <!-- Right Pattern -->
  <img src="assets/Images/pattern.svg"
    style="position: absolute; right: 0; bottom: 0; height: 150px; width: 100px; z-index: 1; transform: rotate(180deg);">
</div>
}


<!-- Grid Mode -->
@if (mode === 'grid') {
<div class="container-fluid py-5 mt-lg-5 px-4">
  <div class="row" dir="rtl">
    <!-- Sidebar -->
    <div class="col-lg-3 mb-4 border rounded-4 py-2 d-none d-lg-block">
      <!-- Search Filter -->
      <div class="mb-4">
        <label class="form-label fw-bold">البحث عن منتج</label>
        <input type="text" class="form-control" placeholder="ابحث عن منتجات..." [(ngModel)]="searchQuery"
          (input)="filterBySearch()" />
      </div>

      <!-- Category Filter -->
      <div class="my-5">
        <h5 class="fw-bold mb-3">الفئات</h5>
        <ul class="list-unstyled">
          @for (cat of categories; track cat.id) {
          <li>
            <label class="form-check d-flex align-items-center gap-2">
              <input class="form-check-input mx-2" type="checkbox" [checked]="selectedCategories.includes(cat.id)"
                (change)="toggleCategory(cat.id)" />
              <span>{{ cat.name_ar }}</span>
            </label>
          </li>
          }
        </ul>
      </div>

      <!-- Price Filter -->
      <div class="my-5">
        <h5 class="fw-bold mb-3">تصفية حسب السعر</h5>
        <div class="d-flex gap-2 mb-2">
          <input type="number" class="form-control text-end" placeholder="من" [(ngModel)]="priceMin" />
          <input type="number" class="form-control text-end" placeholder="إلى" [(ngModel)]="priceMax" />
          <button class="btn btn-success" (click)="applyPriceFilter()">عرض</button>
        </div>

        <!-- Predefined Ranges -->
        <div class="m-4 my-5 px-2">
          @for (range of predefinedRanges; track range.label; let i = $index) {
          <div class="form-check d-flex align-items-center justify-content-start gap-2 mb-2" dir="rtl">
            <input type="checkbox" class="form-check-input mx-2" [checked]="range.selected"
              (change)="applyPredefinedRange(i)" />
            <label class="form-check-label">{{ range.label }}</label>
          </div>
          }
        </div>
      </div>
    </div>
    <!-- زرار الفلترة يظهر فقط على الشاشات الصغيرة -->
    <!-- يظهر فقط في الموبايل -->
    <div class="d-flex justify-content-between gap-2 d-lg-none mt-1 pt-3  py-5">

      <div class="flex-fill">
        <h1 class="fw-bold">المتجر</h1>
      </div>
      <!-- زرار الفلاتر -->
      <button class="btn btn-outline-success flex-fill" style="background-color: #7AD03A; color:black; border: none;"
        (click)="openSidebar()">
        <img src="assets/Images/filter-horizontal.svg" class="">
        &nbsp;تصنيف
      </button>

      <!-- زرار الترتيب -->
      <button class="btn btn-outline-secondary flex-fill">
        الترتيب
      </button>


    </div>

    <!-- Modal -->
<div class="modal fade" id="filtersModal" tabindex="1" aria-labelledby="filtersModalLabel" aria-hidden="true"
     data-bs-backdrop="true" data-bs-keyboard="true">
  <div class="modal-dialog modal-dialog-scrollable custom-modal modal-dialog-bottom">
    <div class="modal-content rounded-4">
          <div class="modal-header">
            <img src="assets/Images/logo.svg" alt="Happy Fitness" style="height: 40px;">
            <div class="mx-5 px-4"></div>
            <div class="modal-header d-flex justify-content-start">
              <h5 class="modal-title fw-bold" id="filtersModalLabel">الغاء</h5>

              <button type="button" class="btn-close px-2 mx-2" data-bs-dismiss="modal" aria-label="إغلاق">

              </button>
            </div>
          </div>
          <div class="modal-body">
            <!-- حط نفس محتوى الـ Sidebar هنا -->
            <div>
              <!-- Search Filter -->
              <div class="mb-4">
                <label class="form-label fw-bold">البحث عن منتج</label>
                <input type="text" class="form-control" placeholder="ابحث عن منتجات..." [(ngModel)]="searchQuery"
                  (input)="filterBySearch()" />
              </div>

              <!-- Category Filter -->
              <div class="my-5">
                <h5 class="fw-bold mb-3">الفئات</h5>
                <ul class="list-unstyled">
                  @for (cat of categories; track cat.id) {
                  <li>
                    <label class="form-check d-flex align-items-center gap-2">
                      <input class="form-check-input mx-2" type="checkbox"
                        [checked]="selectedCategories.includes(cat.id)" (change)="toggleCategory(cat.id)" />
                      <span>{{ cat.name_ar }}</span>
                    </label>
                  </li>
                  }
                </ul>
              </div>

              <!-- Price Filter -->
              <div class="my-5">
                <h5 class="fw-bold mb-3">تصفية حسب السعر</h5>
                <div class="d-flex gap-2 mb-2">
                  <input type="number" class="form-control text-end" placeholder="من" [(ngModel)]="priceMin" />
                  <input type="number" class="form-control text-end" placeholder="إلى" [(ngModel)]="priceMax" />
                  <button class="btn btn-success" (click)="applyPriceFilter()" data-bs-dismiss="modal">
                    عرض
                  </button>
                </div>

                <!-- Predefined Ranges -->
                <div class="m-4 my-5 px-2">
                  @for (range of predefinedRanges; track range.label; let i = $index) {
                  <div class="form-check d-flex align-items-center justify-content-start gap-2 mb-2" dir="rtl">
                    <input type="checkbox" class="form-check-input" [checked]="range.selected"
                      (change)="applyPredefinedRange(i)" />
                    <label class="form-check-label mx-4">{{ range.label }}</label>
                  </div>
                  }
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn close_btn" data-bs-dismiss="modal">تم </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Products Section -->
    <div class="col-lg-9 py-2">
      @if (selectedCategories.length > 0) {
      <div class="mb-3 py-3">
        @for (catId of selectedCategories; track catId) {
        <span class="badge caotegoryDesign me-2 py-1 px-2 rounded-pill">
          <span (click)="removeCategory(catId)" class="ms-2 fs-5" style="cursor: pointer;">&times;</span>

          {{ getCategoryName(catId) }}
        </span>
        }
      </div>
      }

      <!-- Products Grid -->
      <div class="row row-cols-2 row-cols-md-3 g-4 my-4">
        @for (product of filteredProducts; track product.id) {
        <div class="col">
          <div
            class="card h-100 product-card bg-white rounded-4 py-3 border shadow-sm position-relative d-flex flex-column">

            <!-- صورة المنتج -->
            <a [routerLink]="['/product', product.id]" class="text-decoration-none text-dark">
              <img [src]="product.images[0]" class="card-img-top px-3" [alt]="product.name"
                style="height: 200px; object-fit: contain;" />
            </a>

            <!-- أزرار المفضلة والمقارنة -->
            <div class="position-absolute top-0 start-0 p-2 d-flex flex-column gap-2">
              <button (click)="toggleFavorite(product, $event)" class="btn-circle"
                [ngClass]="product.isFavorite ? 'text-danger' : 'text-muted'">
                <i class="fa-heart" [ngClass]="product.isFavorite ? 'fa-solid' : 'fa-regular'"></i>
              </button>

              <button (click)="addToCompare(product); $event.stopPropagation(); $event.preventDefault()"
                class="btn-circle text-muted">
                <i class="fas fa-random"></i>
              </button>
            </div>

            <!-- تفاصيل المنتج + السعر + العربة -->
            <div class="card-body text-end px-3 pb-4 d-flex flex-column justify-content-between flex-grow-1">

              <div>
                <h6 class="card-title fw-bold mb-2">{{ product.name_ar }}</h6>
                <p class="card-text text-muted mb-3" style="font-size: 13px; max-height: 40px; overflow: hidden;">
                  {{ product.description }}
                </p>
                <p class="fw-bold mb-1" style="font-size: 14px;">
                  @if (product.sale_price && product.sale_price !== product.price) {
                  <span class="fw-bold text-success">{{ product.sale_price }} ر.س </span>
                  <span class="text-secondary" style="text-decoration: line-through;">{{ product.price }} ر.س</span>
                  } @else {
                  <span class="fw-bold text-success">{{ product.price }} ر.س </span>
                  }
                </p>

                <!-- الزر أو كنترول الكمية -->
                <div class="py-2">
                  @if (isInCart(product.id)) {
                  <div class="d-flex align-items-center justify-content-center px-3 mt-2 gap-2 border rounded-4"
                    style="direction: rtl;">

                    <!-- Quantity Controls -->
                    <div class="d-flex align-items-center gap-2">
                      <!-- Increase Button -->
                      <button class="btn custom-increase-btn btn-sm"
                        (click)="increaseQuantity(product.id); $event.stopPropagation()">
                        <i class="fa-solid fa-plus"></i>
                      </button>
                      <!-- Quantity Display -->
                      <span class="fw-bold custom-qty-display text-center">
                        {{ getCartItem(product.id)?.quantity }}
                      </span>
                      <!-- Remove Button -->
                      <button class="btn custom-remove-btn btn-sm"
                        (click)="removeItem(product.id); $event.stopPropagation()">
                        <img src="assets/Images/delete-02.svg">
                      </button>
                    </div>
                  </div>
                  } @else {
                  <button class="btn btn-outline-dark w-100 btn-xs bg-white mb-3 text-black rounded-5 custom-hover"
                    style="font-size: 0.9rem;" (click)="addToCart(product, $event)" data-bs-toggle="offcanvas"
                    data-bs-target="#cartSidebar" aria-controls="cartSidebar">
                    <img src="assets/Images/shopping-cart-add-01.svg" style="width: 24px;" class="px-1">

                    إضافة الي العربة
                  </button>





                  }
                </div>

              </div>



            </div>
          </div>

        </div>
        }
      </div>

      <!-- No Products -->
      @if (filteredProducts.length === 0) {
      <div class="text-center mt-5">
        <p class="text-muted">لا توجد منتجات مطابقة للفلترة.</p>
      </div>
      }

    </div>
    <app-downloadapp style="direction: ltr;"></app-downloadapp>

  </div>
</div>
}